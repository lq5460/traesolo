## 目标
- 所有服务均在本机本地部署运行；不依赖云服务。
- 全部开源与免费组件；所有持久化数据与构建产物落到 `/Volumes/mobiledisk`。
- 分阶段演进；每完成一个阶段暂停供你体验后再推进下一阶段。

## 本地环境与原则
- 操作系统：macOS。
- 容器优先：尽量以容器运行各服务，避免主机安装占用系统盘；容器卷映射到 `/Volumes/mobiledisk`。
- 网络：本机 `localhost` 暴露端口；服务间使用容器网络与私有通信。

## 组件与端口（建议）
- Nginx/HAProxy：`80/443`（反向代理与负载均衡）
- Next.js（SSR）：`3001`（Web）
- NestJS（API）：`3000`（REST）
- PostgreSQL：`5432`（主库；后续读写分离引入从库）
- Redis：`6379`
- OpenSearch：`9200/9600`
- Kafka：`9092`（Zookeeper `2181` 或 Kraft 模式）
- MinIO：`9000/9001`（API/Console）
- Prometheus：`9090`；Grafana：`3002`；Loki：`3100`；Jaeger：`16686`

## 外接盘目录规划（mobiledisk）
- 数据：`/Volumes/mobiledisk/data/{postgres,redis,opensearch,kafka,minio}`
- 缓存：`/Volumes/mobiledisk/cache/{nginx,varnish}`
- 日志：`/Volumes/mobiledisk/logs/{app,nginx,system}`
- 容器数据根：`/Volumes/mobiledisk/docker`（镜像/卷尽可能迁至此）
- 备份：`/Volumes/mobiledisk/backup`

## 高层架构图（本地）
```
Browser
  -> Nginx/HAProxy (WAF/SSL)
    -> Edge Cache (Nginx/Varnish)
      -> Web/API Pool (Next.js SSR + NestJS REST)
          -> Redis (对象/列表缓存)
          -> PostgreSQL (主写/后续多从读)
          -> OpenSearch (全文检索)
          -> Kafka (异步索引/统计/通知)
      -> MinIO (媒体/静态源站)

Observability: Prometheus/Grafana, Loki/ELK, Jaeger
Persist & Artifacts: /Volumes/mobiledisk 全量落盘
```

## 分阶段交付（本地）
- 阶段0 单机最小可用（暂停体验）
  - Next.js（SSR）、NestJS（API）、PostgreSQL、Redis 容器化启动，卷映射至 `mobiledisk`。
  - 页面：频道列表/详情；CMS 基础发布；缓存命中与性能基线。
  - 暂停：你体验页面与发布流程。

- 阶段1 Web/数据层分离（暂停体验）
  - Nginx 前置入口；Web/API 与数据库容器分离；Redis 对象缓存生效。
  - 暂停：你体验缓存与入口代理效果。

- 阶段2 水平扩展 + 负载均衡（暂停体验）
  - 多实例 Web/API；Nginx/HAProxy 负载均衡；会话无状态。
  - 暂停：你体验并发与健康检查。

- 阶段3 缓存与静态化（暂停体验）
  - 热门频道/详情静态化；本地边缘 Nginx/Varnish 缓存；发布逐步失效策略。
  - 暂停：你体验热点加速与一致性。

- 阶段4 数据库读写分离（暂停体验）
  - PostgreSQL 一主多从（本地多容器）；读走从库，强一致读走主；索引优化。
  - 暂停：你体验查询性能与一致读路径。

- 阶段5 异步任务与队列（暂停体验）
  - Kafka 本地部署；索引刷新、统计聚合、站内通知、图片转码离线化。
  - 暂停：你体验任务可靠性与重试。

- 阶段6 搜索与推荐（暂停体验）
  - OpenSearch 检索；热门与主题基础推荐；首页流聚合。
  - 暂停：你体验搜索与推荐效果。

- 阶段7 可观测与压测（暂停体验）
  - Prometheus/Grafana/Loki/Jaeger；本地压测与瓶颈定位。
  - 暂停：你审阅观测面板与压测报告。

- 阶段8 灰度、容灾与备份（暂停体验）
  - 金丝雀发布（本地多实例）；自动回滚；备份/恢复演练；缓存降级。
  - 暂停：你体验发布与恢复流程。

## 执行方式
- 优先使用 Docker Compose 编排各阶段服务；所有卷映射到 `/Volumes/mobiledisk`。
- 后续可升级到本地 K3s/Kubernetes；持久卷（HostPath/Local PV）指向 `mobiledisk`。
- OpenSearch 至少分配 4–8GB 内存（本地限额下调并减少分片）。

## 体验与访问
- 每阶段完成后提供本机访问地址（`http://localhost:<port>`）与账号；展示功能点与观测面板。
- 提供用于验证的页面（首页/频道/详情）与 API 路由（`/articles`、`/search` 等）。

## 下一步
- 若你确认该本地部署分阶段方案，我将从“阶段0 单机最小可用”开始，产出容器编排与基础页面/API，并在完成后暂停供你体验。