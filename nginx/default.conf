proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=edge_cache:100m inactive=60m max_size=1g;

map $upstream_cache_status $edge_source {
  default $upstream_addr;
  HIT     "EDGE";
}

upstream api_upstream {
  least_conn;
  server api1:3000 max_fails=3 fail_timeout=10s;
  server api2:3000 max_fails=3 fail_timeout=10s;
}

upstream web_upstream {
  least_conn;
  server web1:3001 max_fails=3 fail_timeout=10s;
  server web2:3001 max_fails=3 fail_timeout=10s;
}

server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  proxy_connect_timeout 5s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;
  resolver 127.0.0.11 ipv6=off valid=10s;
  client_max_body_size 10m;

  set $cache_bypass 0;
  if ($request_method != GET) { set $cache_bypass 1; }
  if ($arg_nocache = 1) { set $cache_bypass 1; }

  # API
  location ^~ /api/ {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering on;
    proxy_cache edge_cache;
    proxy_cache_bypass $cache_bypass;
    proxy_cache_valid 200 30s;
    proxy_next_upstream error timeout http_502 http_504;
    proxy_next_upstream_tries 2;
    add_header Access-Control-Expose-Headers X-Cache-Status,X-Upstream always;
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Upstream $upstream_addr always;
    proxy_pass http://api_upstream;
  }

  location /edge/vars {
    add_header Access-Control-Expose-Headers X-Cache-Status,X-Upstream always;
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Upstream $upstream_addr always;
    return 200 "ua:$upstream_addr cache:$upstream_cache_status method:$request_method uri:$uri args:$args";
  }

  # Web SSR
  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_buffering on;
    proxy_cache_lock on;
    proxy_cache_use_stale error timeout updating;
    proxy_cache_background_update on;
    proxy_cache edge_cache;
    proxy_cache_bypass $cache_bypass;
    proxy_cache_valid 200 12s;
    proxy_next_upstream error timeout http_502 http_504;
    proxy_next_upstream_tries 2;
    add_header Access-Control-Expose-Headers X-Cache-Status,X-Upstream always;
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Upstream $upstream_addr always;
    proxy_pass http://web_upstream;
  }

  location /_next/webpack-hmr {
    proxy_set_header Host $host;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 60s;
    proxy_pass http://web_upstream;
  }
  # Articles static snapshot: try static first, fallback to web
  location ~ ^/articles/(\d+)$ {
    add_header Access-Control-Expose-Headers X-Cache-Status,X-Upstream always;
    add_header X-Cache-Status STATIC always;
    add_header X-Upstream STATIC always;
    root /data/snapshots;
    try_files /articles/$1.html @web_fallback;
  }

  location @web_fallback {
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_buffering on;
    proxy_cache edge_cache;
    proxy_cache_bypass $cache_bypass;
    proxy_cache_valid 200 12s;
    proxy_next_upstream error timeout http_502 http_504;
    proxy_next_upstream_tries 2;
    add_header Access-Control-Expose-Headers X-Cache-Status,X-Upstream always;
    add_header X-Cache-Status $upstream_cache_status always;
    add_header X-Upstream $upstream_addr always;
    proxy_pass http://web_upstream;
  }
}
  # Articles static snapshot: try static first, fallback to web
